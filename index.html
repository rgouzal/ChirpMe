<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realistic Cockatiel Communication - Scientific Implementation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .research-badge {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-align: center;
            margin-bottom: 30px;
            font-weight: bold;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .control-group h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        
        .status.initializing {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status.playing {
            background: #cce5ff;
            color: #004085;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .spectrogram {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 8px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .frequency-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .frequency-range {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .freq-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #2196F3;
        }
        
        .research-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        
        .scientific-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .feature {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #28a745;
        }
        
        .feature h4 {
            margin: 0 0 10px 0;
            color: #28a745;
        }
        
        .error-log {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü¶ú Realistic Cockatiel Communication</h1>
        
        <div class="research-badge">
            üî¨ Based on 2024 Scientific Research | PMC8415583, ECOGEN AI, Cornell Bird Synth
        </div>
        
        <div id="status" class="status initializing">
            Initializing realistic bird sound synthesis...
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>üéµ Natural Calls</h3>
                <button onclick="playContactCall()">Contact Call</button>
                <button onclick="playAlarmCall()">Alarm Call</button>
                <button onclick="playGreetingWhistle()">Greeting Whistle</button>
                <button onclick="playFeedingCall()">Feeding Call</button>
            </div>
            
            <div class="control-group">
                <h3>üó£Ô∏è Conversational Patterns</h3>
                <button onclick="playConversation('greeting')">Greeting Exchange</button>
                <button onclick="playConversation('feeding')">Feeding Sequence</button>
                <button onclick="playConversation('contact')">Contact Sequence</button>
                <button onclick="stopAllSounds()">Stop All</button>
            </div>
            
            <div class="control-group">
                <h3>‚öôÔ∏è Synthesis Settings</h3>
                <label>Intensity: <span id="intensity-value">70%</span></label>
                <input type="range" id="intensity" min="0.1" max="1.0" step="0.1" value="0.7" oninput="updateIntensity()">
                
                <label>Pitch Variation: <span id="pitch-value">10%</span></label>
                <input type="range" id="pitch" min="0" max="0.5" step="0.05" value="0.1" oninput="updatePitch()">
                
                <label>FM Modulation: <span id="fm-value">30%</span></label>
                <input type="range" id="fm" min="0" max="1.0" step="0.1" value="0.3" oninput="updateFM()">
            </div>
        </div>
        
        <div class="spectrogram" id="spectrogram">
            <canvas id="spectrogramCanvas" width="800" height="200"></canvas>
        </div>
        
        <div class="frequency-info">
            <h3>üéº Cockatiel Frequency Ranges (Scientific Research)</h3>
            <div class="frequency-range">
                <div class="freq-item">
                    <strong>Contact Calls</strong><br>
                    1,100 - 1,950 Hz<br>
                    <small>PMC8415583 Study</small>
                </div>
                <div class="freq-item">
                    <strong>Alarm Calls</strong><br>
                    500 - 4,000 Hz<br>
                    <small>Extended Range</small>
                </div>
                <div class="freq-item">
                    <strong>Greeting Whistles</strong><br>
                    1,400 - 4,600 Hz<br>
                    <small>Cornell Research</small>
                </div>
                <div class="freq-item">
                    <strong>Feeding Calls</strong><br>
                    2,000 - 7,000 Hz<br>
                    <small>High Excitement</small>
                </div>
            </div>
        </div>
        
        <div class="research-info">
            <h3>üî¨ Scientific Implementation Features</h3>
            <div class="scientific-features">
                <div class="feature">
                    <h4>Harmonic Synthesis</h4>
                    <p>Multi-harmonic content (1x, 2x, 3x, 4x) with exponential decay for realistic timbre</p>
                </div>
                <div class="feature">
                    <h4>Mathematical Curves</h4>
                    <p>Sine, quadratic, and exponential frequency sweeps based on actual bird analysis</p>
                </div>
                <div class="feature">
                    <h4>Negative Mean Asynchrony</h4>
                    <p>Birds start singing 135ms before playback (PMC8415583 research)</p>
                </div>
                <div class="feature">
                    <h4>Formant Filtering</h4>
                    <p>Resonant emphasis at 3kHz to simulate natural vocal tract filtering</p>
                </div>
                <div class="feature">
                    <h4>AM+FM Modulation</h4>
                    <p>Amplitude and frequency modulation for rich, natural-sounding calls</p>
                </div>
                <div class="feature">
                    <h4>Environmental Context</h4>
                    <p>Band-limited noise and resonance simulation for realistic playback</p>
                </div>
            </div>
        </div>
        
        <div class="error-log" id="errorLog" style="display: none;"></div>
    </div>

    <script src="realistic-cockatiel-sounds.js"></script>
    <script>
        let cockatielSound;
        let currentSources = [];
        let spectrogramData = [];
        
        // Initialize the realistic sound generator
        async function initialize() {
            try {
                updateStatus('initializing', 'Initializing realistic bird sound synthesis...');
                
                // Check Web Audio API support
                if (!window.AudioContext && !window.webkitAudioContext) {
                    throw new Error('Web Audio API not supported in this browser');
                }
                
                cockatielSound = new RealisticCockatielSound();
                await cockatielSound.init();
                
                updateStatus('ready', 'Ready! Realistic cockatiel sounds loaded. Birds should respond to these scientifically-accurate calls.');
                logMessage('‚úÖ Realistic Cockatiel Sound Generator initialized successfully');
                logMessage('üìä Implementation based on: PMC8415583, ECOGEN AI, Cornell Bird Synth');
                logMessage('üéµ Features: Harmonic synthesis, FM modulation, mathematical curves');
                
            } catch (error) {
                updateStatus('error', 'Error: ' + error.message);
                logMessage('‚ùå Error: ' + error.message);
                console.error('Initialization error:', error);
            }
        }
        
        // Play individual calls
        async function playContactCall() {
            try {
                updateStatus('playing', 'Playing realistic contact call...');
                const buffer = await cockatielSound.generateContactCall({
                    intensity: parseFloat(document.getElementById('intensity').value),
                    pitchVariation: parseFloat(document.getElementById('pitch').value)
                });
                await playBuffer(buffer);
                updateStatus('ready', 'Contact call played. Listen for bird response!');
            } catch (error) {
                handleError('Contact call error', error);
            }
        }
        
        async function playAlarmCall() {
            try {
                updateStatus('playing', 'Playing alarm call...');
                const buffer = await cockatielSound.generateAlarmCall({
                    intensity: parseFloat(document.getElementById('intensity').value),
                    urgency: 0.8
                });
                await playBuffer(buffer);
                updateStatus('ready', 'Alarm call played.');
            } catch (error) {
                handleError('Alarm call error', error);
            }
        }
        
        async function playGreetingWhistle() {
            try {
                updateStatus('playing', 'Playing greeting whistle...');
                const buffer = await cockatielSound.generateGreetingWhistle({
                    melody: 'rising',
                    pitch: 0.5
                });
                await playBuffer(buffer);
                updateStatus('ready', 'Greeting whistle played.');
            } catch (error) {
                handleError('Greeting whistle error', error);
            }
        }
        
        async function playFeedingCall() {
            try {
                updateStatus('playing', 'Playing feeding call...');
                const buffer = await cockatielSound.generateFeedingCall({
                    excitement: parseFloat(document.getElementById('intensity').value)
                });
                await playBuffer(buffer);
                updateStatus('ready', 'Feeding call played.');
            } catch (error) {
                handleError('Feeding call error', error);
            }
        }
        
        // Play conversation patterns
        async function playConversation(type) {
            try {
                updateStatus('playing', `Playing ${type} conversation sequence...`);
                const buffers = await cockatielSound.generateConversationPattern(type, 3);
                
                let startTime = cockatielSound.context.currentTime;
                for (let i = 0; i < buffers.length; i++) {
                    const source = await cockatielSound.playBuffer(buffers[i], {
                        startTime: startTime,
                        volume: 0.7
                    });
                    currentSources.push(source);
                    startTime += buffers[i].duration / cockatielSound.sampleRate;
                }
                
                updateStatus('ready', `${type} conversation sequence completed.`);
            } catch (error) {
                handleError('Conversation error', error);
            }
        }
        
        // Play buffer helper
        async function playBuffer(buffer) {
            const source = await cockatielSound.playBuffer(buffer, {
                volume: parseFloat(document.getElementById('intensity').value)
            });
            currentSources.push(source);
            
            // Update FM parameter
            cockatielSound.synthesisParams.fmIndex = parseFloat(document.getElementById('fm').value);
            
            // Generate spectrogram visualization
            generateSpectrogram(buffer);
            
            return source;
        }
        
        // Generate spectrogram visualization
        function generateSpectrogram(buffer) {
            spectrogramData = cockatielSound.createSpectrogramData(buffer);
            drawSpectrogram();
        }
        
        // Draw spectrogram on canvas
        function drawSpectrogram() {
            const canvas = document.getElementById('spectrogramCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            if (spectrogramData.length === 0) return;
            
            const timeStep = width / spectrogramData.length;
            const freqStep = height / 256;
            
            spectrogramData.forEach((frame, timeIndex) => {
                frame.spectrum.forEach((magnitude, freqIndex) => {
                    const intensity = magnitude / 255;
                    const color = getHeatmapColor(intensity);
                    
                    ctx.fillStyle = color;
                    ctx.fillRect(
                        timeIndex * timeStep,
                        height - (freqIndex + 1) * freqStep,
                        timeStep,
                        freqStep
                    );
                });
            });
        }
        
        // Get heatmap color for spectrogram
        function getHeatmapColor(intensity) {
            const colors = [
                [0, 0, 0],
                [0, 0, 255],
                [0, 255, 255],
                [0, 255, 0],
                [255, 255, 0],
                [255, 0, 0]
            ];
            
            const index = Math.floor(intensity * (colors.length - 1));
            const fraction = intensity * (colors.length - 1) - index;
            
            if (index >= colors.length - 1) {
                return `rgb(${colors[colors.length - 1].join(',')})`;
            }
            
            const color1 = colors[index];
            const color2 = colors[index + 1];
            
            const r = Math.round(color1[0] + fraction * (color2[0] - color1[0]));
            const g = Math.round(color1[1] + fraction * (color2[1] - color1[1]));
            const b = Math.round(color1[2] + fraction * (color2[2] - color1[2]));
            
            return `rgb(${r},${g},${b})`;
        }
        
        // Control functions
        function updateIntensity() {
            const value = document.getElementById('intensity').value;
            document.getElementById('intensity-value').textContent = Math.round(value * 100) + '%';
        }
        
        function updatePitch() {
            const value = document.getElementById('pitch').value;
            document.getElementById('pitch-value').textContent = Math.round(value * 100) + '%';
        }
        
        function updateFM() {
            const value = document.getElementById('fm').value;
            document.getElementById('fm-value').textContent = Math.round(value * 100) + '%';
            if (cockatielSound) {
                cockatielSound.synthesisParams.fmIndex = parseFloat(value);
            }
        }
        
        function stopAllSounds() {
            currentSources.forEach(source => {
                try {
                    source.stop();
                } catch (e) {
                    // Source might already be stopped
                }
            });
            currentSources = [];
            updateStatus('ready', 'All sounds stopped.');
        }
        
        // Status and error handling
        function updateStatus(type, message) {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = message;
        }
        
        function logMessage(message) {
            const errorLog = document.getElementById('errorLog');
            errorLog.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            errorLog.innerHTML += `[${timestamp}] ${message}<br>`;
            errorLog.scrollTop = errorLog.scrollHeight;
        }
        
        function handleError(context, error) {
            updateStatus('error', 'Error in ' + context + ': ' + error.message);
            logMessage(`‚ùå ${context}: ${error.message}`);
            console.error(context + ' error:', error);
        }
        
        // Initialize when page loads
        window.addEventListener('load', initialize);
        
        // Resume audio context on user interaction (required by browsers)
        document.addEventListener('click', () => {
            if (cockatielSound && cockatielSound.context.state === 'suspended') {
                cockatielSound.context.resume();
            }
        });
    </script>
</body>
</html>
